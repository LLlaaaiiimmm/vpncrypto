<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Weeden Admin</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="admin-layout">
    {% include 'admin/_sidebar.html' %}

    <div class="main-content">
        <div class="page-header">
            <h1>User Management</h1>
            <button class="btn btn-primary" onclick="openModal()">+ Add User</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for u in users %}
                    <tr>
                        <td style="font-weight:600;">{{ u.name }}</td>
                        <td>{{ u.email }}</td>
                        <td><span class="status-badge status-{{ 'read' if u.role == 'admin' else ('new' if u.role == 'founder' else 'in_progress') }}">{{ u.role }}</span></td>
                        <td>
                            {% if u.is_active %}
                                <span style="color:var(--primary);font-weight:600;">Active</span>
                            {% else %}
                                <span style="color:var(--danger);font-weight:600;">Disabled</span>
                            {% endif %}
                        </td>
                        <td style="font-size:13px;">{{ u.created_at[:16] }}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="toggleUser({{ u.id }})">
                                {{ 'Disable' if u.is_active else 'Enable' }}
                            </button>
                            {% if u.id != user.id %}
                            <button class="btn btn-sm btn-danger" onclick="deleteUser({{ u.id }}, '{{ u.name }}')">Delete</button>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal-overlay" id="addUserModal">
    <div class="modal">
        <h2>Add New User</h2>
        <div id="modalError" style="display:none;background:#FEE2E2;color:#991B1B;padding:10px;border-radius:8px;font-size:13px;margin-bottom:16px;"></div>
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="userName" placeholder="John Doe">
        </div>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="userEmail" placeholder="john@weeden.com">
        </div>
        <div class="form-group">
            <label>Password (min 10 characters)</label>
            <input type="password" id="userPassword" placeholder="Minimum 10 characters">
        </div>
        <div class="form-group">
            <label>Role</label>
            <select id="userRole">
                <option value="founder">Founder</option>
                <option value="ceo">CEO</option>
                <option value="admin">Admin</option>
            </select>
        </div>
        <div class="actions">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createUser()">Create User</button>
        </div>
    </div>
</div>

<script>
function openModal() { document.getElementById('addUserModal').classList.add('active'); }
function closeModal() { document.getElementById('addUserModal').classList.remove('active'); document.getElementById('modalError').style.display = 'none'; }

async function createUser() {
    const name = document.getElementById('userName').value;
    const email = document.getElementById('userEmail').value;
    const password = document.getElementById('userPassword').value;
    const role = document.getElementById('userRole').value;
    const errEl = document.getElementById('modalError');

    if (!name || !email || !password) { errEl.textContent = 'All fields are required'; errEl.style.display = 'block'; return; }
    if (password.length < 10) { errEl.textContent = 'Password must be at least 10 characters'; errEl.style.display = 'block'; return; }

    const res = await fetch('/api/users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name, email, password, role})
    });
    if (res.ok) { location.reload(); }
    else {
        const data = await res.json();
        errEl.textContent = data.detail || 'Error creating user';
        errEl.style.display = 'block';
    }
}

async function toggleUser(id) {
    await fetch(`/api/users/${id}/toggle`, {method: 'POST'});
    location.reload();
}

async function deleteUser(id, name) {
    if (!confirm(`Delete user "${name}"? This cannot be undone.`)) return;
    const res = await fetch(`/api/users/${id}/delete`, {method: 'POST'});
    if (res.ok) location.reload();
    else { const d = await res.json(); alert(d.detail || 'Error'); }
}
</script>
</body>
</html>
